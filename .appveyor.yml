version: 1.0.0b1{build}
build: off

environment:
  REDIS: "C:\\ProgramData\\chocolatey\\lib\\redis-64"
  PYTHONASYNCIODEBUG: "1"
  matrix:
  - PYTHON: "C:\\Python36"
  - PYTHON: "C:\\Python36-x64"
  - PYTHON: "C:\\Python37"
  - PYTHON: "C:\\Python37-x64"

install:
- "cinst redis-64"
- "%PYTHON%\\python.exe -m pip install -r tests/requirements.txt"
- "%PYTHON%\\python.exe -m pip install -e ."

test_script:
- "%REDIS%\\redis-server.exe --version"
- "%PYTHON%\\python.exe -c \"import sys; print(sys.version)\""
- "%PYTHON%\\python.exe -m pytest -svv --cov --cov-report=xml --junit-xml=results.xml --redis-server=%REDIS%\\redis-server.exe"

on_finish:
- ps: >-
    $wc = New-Object 'System.Net.WebClient'

    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path results.xml))
- "%PYTHON%\\python.exe -m pip install codecov"
- "%PYTHON%\\python.exe -m codecov -f \"coverage.xml\""
